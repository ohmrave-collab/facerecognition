<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <style>
    body { font-family: 'Sarabun', sans-serif; text-align: center; padding: 20px; background: #f8f9fa; }
    .container { max-width: 500px; margin: auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    video { width: 100%; border-radius: 10px; background: #333; }
    input { width: 90%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; }
    button { background: #28a745; color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; font-size: 16px; }
    button:disabled { background: #ccc; }
    #status { margin-top: 15px; color: #666; }
  </style>
</head>
<body>

<div class="container">
  <h2>ลงทะเบียนพนักงานใหม่</h2>
  <input type="text" id="userId" placeholder="รหัสพนักงาน (เช่น 001)">
  <input type="text" id="userName" placeholder="ชื่อ-นามสกุล">
  
  <div style="position:relative;">
    <video id="video" autoplay muted></video>
  </div>

  <p id="status">กำลังโหลด AI...</p>
  <button id="btnCapture" disabled>ถ่ายรูปและลงทะเบียน</button>
</div>

<script>
  const video = document.getElementById('video');
  const btnCapture = document.getElementById('btnCapture');
  const status = document.getElementById('status');
  const MODEL_URL = 'https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights/';

  async function init() {
    // โหลด Model ที่จำเป็น
    await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
    await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
    await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
    
    // เปิดกล้อง
    navigator.mediaDevices.getUserMedia({ video: {} })
      .then(stream => {
        video.srcObject = stream;
        status.innerText = "พร้อมลงทะเบียน";
        btnCapture.disabled = false;
      });
  }

  btnCapture.addEventListener('click', async () => {
    const id = document.getElementById('userId').value;
    const name = document.getElementById('userName').value;

    if (!id || !name) {
      alert("กรุณากรอกรหัสและชื่อให้ครบถ้วน");
      return;
    }

    btnCapture.disabled = true;
    status.innerText = "กำลังประมวลผลใบหน้า...";

    // ตรวจจับใบหน้าและดึง Descriptor (ตัวเลข 128 ตัว)
    const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
      .withFaceLandmarks()
      .withFaceDescriptor();

    if (detection) {
      const descriptor = Array.from(detection.descriptor); // แปลงเป็น Array ปกติ
      
      // ส่งข้อมูลไปบันทึกใน Google Sheets
      google.script.run.withSuccessHandler(res => {
        alert(res);
        location.reload(); // รีเฟรชหน้า
      }).registerNewUser(id, name, descriptor);
      
    } else {
      alert("ไม่พบใบหน้า กรุณาจัดตำแหน่งหน้าให้ตรงกล้อง");
      btnCapture.disabled = false;
      status.innerText = "ลองใหม่อีกครั้ง";
    }
  });

  init();
</script>
</body>
</html>
